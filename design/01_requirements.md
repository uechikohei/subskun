# 要件定義（Requirements）: サブスクリプション管理 iOSアプリ

- **対象スコープ**: iOSアプリ（ローカル完結）でサブスク情報・請求履歴（見込み/確定）を管理し、JSON/CSVへ出力する。
- **作成日/更新日**: 2026-02-06
- **バージョン**: v0.1
- **ステータス**: Draft
- **想定読者**: PM / iOS Dev / QA / 運用
- **この資料の使い方**:
  - FR（機能要件）とNFR（非機能要件）を「受け入れ条件」まで読んで、実装範囲と完成条件を揃える
  - 実装中に迷ったら、まずこの受け入れ条件に立ち返る

---

## 1. 目的（ユーザー価値）
- iPhone上でサブスクを簡単に登録・更新でき、現在の契約状況が一目でわかる。
- 「いつ・いくら支払っているか（見込み/実績）」を履歴として残せる。
- いつでもJSON/CSVへ出力して、外部で分析・可視化できる。

## 2. ユースケース一覧
- UC-001 サブスクを登録する
- UC-002 サブスクを更新/解約/一時停止する
- UC-003 一覧で月額合計・次回請求日を確認する
- UC-004 請求履歴（見込み/確定）を確認する
- UC-005 請求履歴を「確定」にする/金額を修正する
- UC-006 条件で絞り込み（状態/カテゴリ/検索）をする
- UC-007 JSON/CSVとしてエクスポートする
- UC-008 データをバックアップ/復元（v0.1は復元=Out of Scope）

## 3. ユーザーストーリー
- US-001 As a iPhoneユーザー, I want サブスクをスマホでサクッと登録できる, So that 管理が散らばらない。
- US-002 As a ユーザー, I want 月額/年額の合計を見たい, So that 固定費の把握ができる。
- US-003 As a ユーザー, I want 次回請求日と金額を把握したい, So that 不意の出費を防げる。
- US-004 As a ユーザー, I want 過去の支払い履歴を残したい, So that 利用実績を振り返れる。
- US-005 As a ユーザー, I want JSON/CSVで外部出力したい, So that 将来グラフ化や別ツール分析に使える。

---

## 4. 機能要件（Functional Requirements）

### FR-001 サブスク項目の作成
- **説明**: サービス名、金額、請求周期、開始日（または初回請求日）などを登録できる。
- **受け入れ条件（Given/When/Then）**
  - Given 新規登録画面を開いている
  - When 必須項目（サービス名、金額、周期、開始日）を入力し保存する
  - Then 一覧に新しいサブスクが表示され、次回請求日が計算されている

### FR-002 サブスク項目の閲覧（一覧/詳細）
- **説明**: 一覧で主要情報、詳細で全情報を確認できる。
- **受け入れ条件**
  - Given サブスクが1件以上存在する
  - When 一覧画面を表示する
  - Then 各サブスクの「サービス名・状態・金額・次回請求日」が見える
  - When 任意のサブスクをタップする
  - Then 詳細画面で登録情報と履歴サマリが見える

### FR-003 サブスク項目の編集
- **説明**: 金額、周期、カテゴリ、メモ等を編集できる。
- **受け入れ条件**
  - Given 既存サブスクの詳細画面を開いている
  - When 編集して保存する
  - Then 変更が永続化され、一覧/詳細の表示に反映される

### FR-004 状態管理（Active/Paused/Cancelled）
- **説明**: 利用中/一時停止/解約を管理できる。
- **受け入れ条件**
  - Given サブスクが存在する
  - When 状態をPausedに変更する
  - Then 一覧にPausedとして表示され、集計の対象外/対象内は設定方針通りになる（※方針は後述）
  - When 状態をCancelledに変更し、解約日を設定する
  - Then 解約日以降の請求イベントは生成/表示されない（または無効扱いになる）

### FR-005 請求周期のサポート
- **説明**: 少なくとも「月次」「年次」「カスタム（日数）」をサポートする。
- **受け入れ条件**
  - Given 新規/編集画面
  - When 周期=月次/年次/カスタムを選択する
  - Then 次回請求日計算にその周期が使われる

### FR-006 請求スケジュール（見込み履歴）の自動生成
- **説明**: サブスク定義から、過去〜未来の請求イベント（見込み）を生成・表示する。
- **受け入れ条件**
  - Given サブスクが存在し、開始日と周期が設定されている
  - When 履歴タブを開く
  - Then 過去Nヶ月〜未来Mヶ月の範囲で請求イベントが表示される（N/Mは設定 or 固定）

### FR-007 請求イベントの確定（支払い済み）
- **説明**: 見込みイベントを「確定」にできる。
- **受け入れ条件**
  - Given あるサブスクの請求イベント一覧が表示されている
  - When 1つのイベントを「確定」操作する
  - Then そのイベントがConfirmedとして表示され、エクスポートにも反映される

### FR-008 請求イベントの上書き（例: 値上げ/割引/実額差異）
- **説明**: 特定回の金額だけ上書きできる。
- **受け入れ条件**
  - Given 請求イベント詳細を開いている
  - When 金額を編集して保存する
  - Then そのイベントだけ変更後の金額で表示・集計・エクスポートされる

### FR-009 集計（当月/年間の合計）
- **説明**: 少なくとも「当月見込み合計」「当月確定合計」「年間見込み合計」を表示する。
- **受け入れ条件**
  - Given サブスクが複数存在し、イベントが生成されている
  - When サマリ画面を開く
  - Then 当月の見込み/確定の合計が表示される

### FR-010 カテゴリ/タグ（任意）
- **説明**: サブスクにカテゴリ（例: エンタメ/仕事/学習）を付けられる。
- **受け入れ条件**
  - Given サブスク編集画面
  - When カテゴリを選択して保存
  - Then 一覧や集計でカテゴリ別に絞り込み/集計できる

### FR-011 検索・フィルタ
- **説明**: サービス名検索、状態フィルタ（Active/Paused/Cancelled）を提供する。
- **受け入れ条件**
  - Given サブスクが複数存在する
  - When 状態=Activeでフィルタ
  - Then Activeのサブスクのみ表示される
  - When 検索欄に文字列入力
  - Then サービス名に一致するサブスクが表示される

### FR-012 JSONエクスポート
- **説明**: 現在のサブスク定義 + 請求イベント履歴をJSONで出力できる。
- **受け入れ条件**
  - Given サブスクが存在する
  - When エクスポート形式=JSONを選んで実行する
  - Then 共有シート等で `.json` ファイルとして出力できる
  - And JSONはスキーマ（後述）に従う

### FR-013 CSVエクスポート
- **説明**: 履歴（イベント行）をCSVで出力できる。
- **受け入れ条件**
  - Given サブスクが存在し、イベントが生成されている
  - When エクスポート形式=CSVを選んで実行する
  - Then `.csv` ファイルとして出力できる
  - And 1行=1請求イベントとして出力される

### FR-014 エクスポート対象の選択
- **説明**: 「サブスク定義のみ」「履歴のみ」「両方」を選べる（v0.1で簡易でも可）。
- **受け入れ条件**
  - Given エクスポート画面
  - When 対象=履歴のみ を選んで実行
  - Then CSV/JSONに履歴のみが含まれる

### FR-015 ローカル永続化
- **説明**: アプリを落としてもデータが消えない。
- **受け入れ条件**
  - Given サブスクを保存済み
  - When アプリを終了し再起動
  - Then サブスクと履歴が同じ状態で表示される

### FR-016 削除
- **説明**: サブスクを削除できる（履歴も含めるかは方針で決める）。
- **受け入れ条件**
  - Given サブスク詳細画面
  - When 削除を実行し確認ダイアログで確定
  - Then 一覧から消え、履歴も方針通りに扱われる（v0.1は物理削除を基本）

### FR-017 設定
- **説明**: デフォルト通貨、履歴生成範囲（Nヶ月/Mヶ月）などを設定できる。
- **受け入れ条件**
  - Given 設定画面
  - When 履歴生成範囲を変更して保存
  - Then 履歴表示やエクスポート範囲に反映される

---

## 5. 非機能要件（Non-Functional Requirements）

### NFR-001 パフォーマンス
- 一覧表示はサブスク100件程度でもストレスなくスクロールできる。
- 受け入れ条件
  - Given サブスク100件、履歴イベント合計3000行が存在
  - When 一覧/履歴を表示して操作する
  - Then 目立つフリーズなく操作できる（目安: 主要操作が1秒以内に反応）

### NFR-002 可用性/オフライン
- バックエンドなしのため、オフラインでも全機能（閲覧/登録/エクスポート）が動作する。

### NFR-003 データ保全
- 予期せぬクラッシュ後でもデータ破損を極小化する（トランザクション/永続化の安全な運用）。

### NFR-004 セキュリティ/プライバシー
- 個人情報（氏名/住所等）は扱わない設計にし、ログにも出さない。
- エクスポート時は内容をユーザーが理解できるUI（注意文）を出す。

### NFR-005 保守性
- ドメインロジック（請求日計算、エクスポート）はUIから分離し、ユニットテスト可能にする。

### NFR-006 アクセシビリティ
- Dynamic Type、VoiceOverの最低限対応（読み上げラベル）を行う。

### NFR-007 コスト
- v0.1はバックエンドなし・無料運用（サーバー費ゼロ）を前提。

### NFR-008 監視/運用（最小）
- クラッシュログを取得できる仕組み（Xcode Organizer / 任意でFirebase Crashlytics）を用意する。

---

## 6. 制約条件
- iOSネイティブ実装（SwiftUI）。
- 最低サポートOS: **iOS 17**（Assumptions）。
- バックエンドなし（ローカル完結）。
- v0.1は日本語UI、通貨デフォルトJPY。

## 7. データ要件
- 扱うデータ
  - サブスク定義: サービス名、金額、通貨、周期、開始日、次回請求日、状態、カテゴリ、メモ
  - 請求イベント: 請求日、金額、通貨、状態（見込み/確定）、メモ
- PII
  - 原則扱わない（ただしメモ欄にユーザーが書く可能性があるため、**アプリ側ログにメモを出さない**）
- 保存期間
  - ユーザーが削除するまで（ローカル保持）

## 8. 画面/入出力（UIがある場合）

### 画面一覧（案）
- 画面S-001 サマリ（今月合計・次回請求）
- 画面S-002 サブスク一覧（検索/フィルタ）
- 画面S-003 サブスク詳細（基本情報 + 履歴）
- 画面S-004 サブスク作成/編集
- 画面S-005 エクスポート（JSON/CSV/範囲選択）
- 画面S-006 設定

### ワイヤー（超簡易）
```
[タブ]
- サマリ | 一覧 | 設定

サマリ
- 今月(見込み): ¥12,340
- 今月(確定):   ¥8,900
- 次回請求: 2/10  ¥1,200 (Netflix)

一覧
- [検索欄] [Active▼]
- Netflix   Active  ¥1,200  次回 2/10
- iCloud    Active  ¥130    次回 2/15

詳細
- 基本情報
- 履歴(見込み/確定) リスト
- [確定] [金額編集]

エクスポート
- 形式: JSON / CSV
- 範囲: 定義のみ / 履歴のみ / 両方
- [共有]
```

## 9. エッジケース
- 月末開始（1/31開始の月次）で「存在しない日」が出る（2/31等）
- うるう年（2/29）
- 金額が途中で変わる（値上げ/キャンペーン）
- 無料トライアル期間（初回請求日が開始日より後）
- 解約日を過去に設定した場合の履歴整合
- 通貨/小数（将来）
- データ量増加（履歴が膨らむ）

## 10. リスクと緩和策
- リスクR-001: 請求日計算の例外（月末/うるう年）でズレる
  - 緩和: テストケースを網羅（`06_test_strategy.md`）し、計算ルールを明文化
- リスクR-002: 「見込み」と「確定」の意味がUIで混乱
  - 緩和: 表示ラベルとヘルプ、色/アイコンで区別（ただし色依存しない）
- リスクR-003: エクスポートデータの互換性が壊れる
  - 緩和: バージョン字段をJSONに入れる、CSV列を固定し追加は後方互換にする

## 11. 計測（ログ/メトリクス/トレース）
- v0.1は最小限
  - 重要イベント: サブスク作成/更新/削除、エクスポート実行
  - エラー: エクスポート失敗、DB保存失敗、計算例外
- 収集方法
  - OSLog（PIIを含めない）
  - 任意でクラッシュレポート（Crashlytics等）

---

## Assumptions（前提）
- iOS 17+ を対象に SwiftUI + SwiftData を採用する。
- 履歴は「見込み（自動生成）」と「確定（手動確定）」を扱う。

## Open Questions（未確定事項）
- 「Paused」を集計に含めるか（デフォルトは含めない想定）。
- 履歴生成範囲（過去Nヶ月/未来Mヶ月）のデフォルト値。

## Decisions（決定事項）
- v0.1はエクスポートのみ（インポートは将来）。

## Out of Scope（やらないこと）
- 明細自動取り込み
- iCloud同期
- 高度なグラフ機能（エクスポートを前提に外部で実施）
